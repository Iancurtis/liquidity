language: scala
jdk:
  - openjdk8
sudo: required
services:
  - docker
env:
  global:
    - secure: AvSUXoRtT6mvnoqg2+ktqp0LAWE/bU/vrNYa5P+f+jm04tZdvgLlRim6U1CbPQIZnOz+lf2xEdhIei3p8Jmw6OxJ6Vdn2mhOorePNfJv/sGptzFhNLVhCyif1MNeut205XUYPUgxJoLe+yWdNAm8zoLwY+AdGOEcSxwLkaL/1cV8bc1CFTwO/Dd7XdMZh87iO/Qkmy4lQOEVcd8T/q4xxChocXbXU9Y3gSYxZt2Aj46a7KX7FLYm2ZZwZ/Xmw0GYVp8AsBcEQu3M5kuKFFX9ksYMNUmuEOvtK0rVe1r1saqXD+CFQnoa1MMMODM85cI4m/YmTDYtrCBCmINg5RDfi6D8ZNkE9L5+t27dJo6vXThprcQfkKZRFKO27dzgbW5RvT8cJ2+GwlWHgu6hhsdVIiVJPDK+mfi8ignZmrWhSys9wOFbnu4FdH9LN1CfBV24ffDdAUSo1xhYe6S4ghVaXyRZz2zXf8ETfJl+yZ6FZSBL7Ozasuv2AtEvJNY1uciGtsuaHkloqrB5LCBrvF+hgrJZM0JhCvB9ibb+KFJ7bTqOuZAPxIbZ5rlUxe0pxKv7E3Y8kFX41T4An9NwWS6C+YhJe5qmhMIdyUApZH8VEKicwvKuPZ063FUbzEbrTpnFCn9snECQeznWX6Rq7YXe9VHH7p5VouQRbw0hbjFOD5g=
    - secure: tKMonHSs1doCvc0HKPseLPWqLE0pkWzG9CKJ+WHbpqILUh2VezIFwRjYrALyIXzSoH9ocWMqOUCSwAMO28ny1lGUtJanEJ0CBUAReAEg2IH3f0J56TcGhpeQnB1pV9nPszn6sVH/X92GLhNXBUGo/nbD2YgZpkRD6kpwubTMr6qHROF/K1Tohg2YBxbZd+7wUbpAhmJur7QFvW4GKlvbUX/r9nXxI06WA5i6tBsW0cx1mficYu7RVK7yZB1BR7V6awxCVbyA3ui6OWKQhG0z7MnbVUWtKZoXttDAbk32UAQE5hQxta3Q1Xz3RkiF84BTe0InYj51N1GMTVEI3z6yBA1sU/sjOjwocHQGdapXWiP2aqNlhVOwMAzaiILQI9c1HwtVxegODTMDtKaH7qhG8NBADjAXU4RX5ioZ4/Pi5Yq4HhUasFfxjudWmIiRhJ7Ebe0Xe40AubkG21bHmJ/0lh0ctebFkefOJYRGLTxS8bcJga3/bx8kNsVWGtgxQTLiwcAWotwmibIqFyItJoZtk8ChzHXj4UzGmGXtcuceRQTEbiKZ4lB+r76h0qkP1RytJSXkQALJuh6XD0fA6Vj3pVhBZtPIRhH9thbBrY5bUbNzqvB/0lLIi3R7ThBHD3tRWdgmR7tCdJhp9kFY9/zpiN78+teUJhBRiqIeLAWo4gA=
    - secure: BCU14UKhyeUCWCVcF6SuidH3SeZzU1jkfAtyrx8roWpTwaMD5zrBF1zlWJHtYcDBq/b1MpdXGYY+Mq30KtBaobXKDkU/B+MHJCvN1eHHBO7NxNw+/U5IICs/2IV/jC9ANMevMO4pGQbx15DiZcGGk0uIyZiWtX7u8cGcM+i6ldLAdPoVl/8Wj2KUH9y5ZvCGn5BJBA+UJbum/watf7t6bYvlnFcesJ5ahL4TvwLMksTqp20vc7YUmO5FnnoXt4HZFhMjbr5i35MLTXoM4Z1TYbdfod0tnIs3pf2A5up+X/wOxTnmW8+p7iLeu1GsQLAtsPPXiIYqdA8TBJ7jwHPsdIbfFYyJT4lzeaXqOs5gf7LhbzU1ehMuLo7K8p9yfXiXoYW62bBJy0KCeEvBYeCrylI7Y/x9uauuowCIie/iknLC5xI0dO5Off7ModOvpXRuj0pWS8hEEXH0eTqaNPnl7LSIp5C6kTQ2HNHUaCNWAYXx9Wf1kWJOu6k4eQVEBdg5NnMDuB2fRWCqFVSLd1MEHFnbd/Ll4SnIDo7DMk6NLPZ+aIDtYyMtvtRrg6b1P8wOGwkzxMTMtPFFdYFWEuni4IBF0wmTye781v0DQzTAmvT2WNIxwjb6kljHjlBHouVdmcKUeVSN9VQ4+D0G00Ti0SFqSp+K1wlgLNm7YuN8tvU=
    - secure: O+QOjGKLJgCPfeQ+LGBc5JvdqsfbSRig2d6Hx5RRU9yutcYqtj+QwKqS7f4d14m5Ob9nppV7GDWTlJdgCMYyRDkpo+kSk//05t2JdwnbXcL44Wozq9O3g5ETS9mC9aPDt1BpoPXJr6P6woInBH09ysWzsk4Jt275w1CJOytZrSlnY1biTtpRexQmWp/2Zr/JEV5MdeYiX0U++/UeOwdct7IxIzz8Up3Q9NzCQaB1zxMY5RgoJebQHAjZmqCissBjGR8z26St5sgyfa4tHHBB4MaKJgdDyGg/MtnJMCmhWwEIOLU5v73r3Jnil2cvDKJAbvM1u6zAozO2i1U1UNRPX9UaWjh8ooTV3vZo+kREfUB37fWHSWcbObNKBWn7rZfhDvFR7o2zch0hqoFdJOgpuTJlJCVPr+X+YwBa+qInG/8QWyU5AIKJL/qMlNifOqTsXNqUBLe+tMNEa49u/VfR/Ybp9l3spSTdXNV56aPBWZOQjODeK6OnWCW9sYp1F387ALB1rCmcNfvDjH8wGcwZhxuFt5vdygeBIEAWDRj0XhDNa0s+rY/FFUDqf+GjAvyH6mP5o78pzGzh+YYlH8dWA/+y3+M26kq/4JpebPXC8vKqnfcrcrs+im9ALcXUm7aJG+UfpV+YS5rcJ1RRA+NrCUL0FINMd4asSpzsfbwwSvQ=
stages:
  - name: test
  - name: deploy
    if: branch = master
  - name: test-deployment
    if: branch = master
  - name: release
    if: branch = master
jobs:
  include:
    - stage: test
      script: |
        shellcheck **/*.sh &&
        ./cd-scripts/test-units.sh &&
        bash <(curl -s https://codecov.io/bash)
    - stage: test
      script: |
        pip install --user awscli && export PATH=$PATH:$HOME/.local/bin &&
        ./cd-scripts/test-component-and-publish.sh eu-west-1 prod-blue
    - stage: deploy
      script: |
        pip install --user awscli && export PATH=$PATH:$HOME/.local/bin &&
        ./cd-scripts/deploy-service.sh eu-west-1 prod-blue
    - stage: test-deployment
      script: |
        pip install --user awscli && export PATH=$PATH:$HOME/.local/bin &&
        ./cd-scripts/test-deployment.sh eu-west-1 prod-blue api
    - stage: release
      script: |
        # So sbt-dynver derives the version correctly
        git fetch --unshallow && ./cd-scripts/release.sh
cache:
  directories:
    - $HOME/.sbt
    - $HOME/.ivy2/cache
    - $HOME/.coursier
